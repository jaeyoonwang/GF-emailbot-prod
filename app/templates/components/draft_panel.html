<!-- Draft panel â€” loaded via HTMX when "Generate Response" is clicked -->
<div class="mt-4 border-t border-gray-200 pt-4 fade-in">
    <div class="flex items-center justify-between mb-2">
        <h4 class="text-sm font-semibold text-gray-700">Draft Reply</h4>
        <div class="flex items-center space-x-2 text-xs text-gray-400">
            {% if style_source == 'specific' %}
            <span class="bg-green-50 text-green-700 px-2 py-0.5 rounded">Personalized â€” {{ style_email_count }} emails to this sender</span>
            {% elif style_source == 'general' %}
            <span class="bg-yellow-50 text-yellow-700 px-2 py-0.5 rounded">General style â€” {{ style_email_count }} recent emails</span>
            {% else %}
            <span class="bg-gray-50 text-gray-500 px-2 py-0.5 rounded">No style context</span>
            {% endif %}
            <span>{{ tokens_used }} tokens</span>
        </div>
    </div>

    <textarea
        id="draft-text-{{ email_id }}"
        class="w-full border border-gray-300 rounded-lg p-3 text-sm text-gray-800 leading-relaxed focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        rows="8"
    >{{ draft }}</textarea>

    <div class="flex items-center justify-between mt-3">
        <label class="flex items-center space-x-2 text-sm text-gray-600">
            <input type="checkbox" id="confirm-send-{{ email_id }}" class="rounded border-gray-300">
            <span>I confirm I want to send this email</span>
        </label>
        <div class="flex items-center space-x-2">
            <button
                onclick="sendReply('{{ email_id }}', '{{ sender_email }}', '{{ subject }}')"
                class="px-4 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-lg transition disabled:opacity-50"
            >
                ðŸ“¤ Send Reply
            </button>
        </div>
    </div>
</div>

<script>
function sendReply(emailId, toEmail, subject) {
    var checkbox = document.getElementById('confirm-send-' + emailId);
    if (!checkbox || !checkbox.checked) {
        showToast('Please confirm before sending.', 'error');
        return;
    }

    var textarea = document.getElementById('draft-text-' + emailId);
    var body = textarea.value.trim();
    if (!body) {
        showToast('Draft is empty.', 'error');
        return;
    }

    // Add Re: prefix if needed
    var reSubject = subject;
    if (!subject.startsWith('Re:') && !subject.startsWith('RE:')) {
        reSubject = 'Re: ' + subject;
    }

    // Convert plain text to HTML
    var bodyHtml = '<html><body>' + body.replace(/\n/g, '<br>') + '</body></html>';

    fetch('/api/emails/' + emailId + '/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            to_email: toEmail,
            subject: reSubject,
            body_html: bodyHtml
        })
    })
    .then(function(response) {
        if (response.ok) {
            showToast('Email sent successfully!', 'success');
            // Remove the email card from the list
            var card = textarea.closest('div.bg-white.rounded-lg');
            if (card) card.remove();
        } else {
            return response.json().then(function(data) {
                showToast('Send failed: ' + (data.detail || 'Unknown error'), 'error');
            });
        }
    })
    .catch(function(err) {
        showToast('Network error: ' + err.message, 'error');
    });
}
</script>